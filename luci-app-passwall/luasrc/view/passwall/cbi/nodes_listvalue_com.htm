<%
--	Template Developers:
--		- lwb1978
--		- snowie2000
--	Copyright: copyright(c)2025–2027
--	Description: Passwall(2) UI template
-- It is the common part of the template and cannot be used independently
%>
<style>
/* 主下拉按钮的下箭头 */
.lv-arrow-down {
	width: 0;
	height: 0;
	border-left: 5px solid transparent;
	border-right: 5px solid transparent;
	border-top: 6px solid #666;
	margin-left: 6px;
	display: inline-block;
	vertical-align: middle;
}
/* 组标题的右箭头（折叠） */
.lv-arrow-right {
	width: 0;
	height: 0;
	border-top: 4px solid transparent;
	border-bottom: 4px solid transparent;
	border-left: 5px solid #555;
	display: inline-block;
	vertical-align: middle;
}
/* 组标题的下箭头（展开） */
.lv-arrow-down-small {
	width: 0;
	height: 0;
	border-left: 4px solid transparent;
	border-right: 4px solid transparent;
	border-top: 5px solid #555;
	display: inline-block;
	vertical-align: middle;
}
/* 基础列表项样式 */
.cbi-listvalue-panel li[data-key] {
	padding: 6px;
	border-radius: 4px;
	cursor: pointer;
	white-space: nowrap;
	overflow: hidden;
	text-overflow: ellipsis;
	transition: background-color 0.15s ease;
}
/* 鼠标悬停效果 - 使用透明度避免覆盖问题 */
.cbi-listvalue-panel li[data-key]:hover {
	background-color: rgba(0, 123, 255, 0.1);
}
/* 选中项样式 - 使用更高优先级 */
.cbi-listvalue-panel li[data-key].is-selected {
	background-color: #007bff !important;
	color: white !important;
	font-weight: 600 !important;
}
/* 选中项悬停时保持主色调 */
.cbi-listvalue-panel li[data-key].is-selected:hover {
	background-color: #0056b3 !important;
}

.lv-dropdown-container {
	display: inline-block;
	position: relative;
	min-width: 220px;
	white-space: nowrap;
}
@media (max-width: 1152px) {
	.lv-dropdown-container {
		white-space: normal;
	}
}
@media (max-width: 600px) {
	.lv-dropdown-container {
		display: block;
		white-space: normal;
	}
}

.lv-dropdown-display {
	cursor: pointer;
	display: inline-flex;
	align-items: center;
	justify-content: space-between;
	box-sizing: border-box;
}
.lv-dropdown-label {
	display: inline-block;
	overflow: hidden;
	white-space: nowrap;
	max-width: calc(100% - 18px);
}
.lv-dropdown-panel {
	position: fixed;
	top: 0;
	left: 0;
	z-index: 2147483647;
	border: 1px solid #dcdcdc;
	border-radius: 4px;
	box-shadow: 0 6px 18px rgba(0,0,0,0.08);
	max-height: 50vh;
	overflow: auto;
}
.lv-dropdown-search {
	width: 100%;
	max-width: 100% !important;
	min-width: 0 !important;
	box-sizing: border-box;
	padding: 6px;
	border: 1px solid #e0e0e0;
	border-radius: 4px;
}
.lv-group-title {
	cursor: pointer;
	padding: 6px;
	border-radius: 4px;
	display: flex;
	align-items: center;
	line-height: normal;
	white-space: nowrap;
}
.lv-group-list {
	list-style: none;
	margin: 6px 0 0 8px;
	padding: 0;
}
.lv-group-item {
	padding: 6px;
	border-radius: 4px;
	cursor: pointer;
	white-space: nowrap;
	overflow: hidden;
	text-overflow: ellipsis;
	text-align: left !important;
}
</style>

<script type="text/javascript">
//<![CDATA[
	// css helper functions
	function lv_camelToKebab(str) {
		return str.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g, '$1-$2').toLowerCase()
	}

	function lv_style2Css(styleDeclaration, properties) {
		const cssRules = properties.map(prop => {
			const kebabCaseProp = lv_camelToKebab(prop);[1, 5]
			const value = styleDeclaration[prop]
			if (value) {
				return `${kebabCaseProp}: ${value};`
			}
			return ''
		})
		// Filter out any empty strings and join the rules
		return cssRules.filter(Boolean).join(' ')
	}

	function lv_parseColorToRgba(color) {
			if (!color) return null;

			const ctx = document.createElement('canvas').getContext('2d');
			if (!ctx) return null;

			ctx.fillStyle = color;
			const computedColor = ctx.fillStyle;
			// Match #RRGGBB or #RRGGBBAA format
			if (computedColor.startsWith('#')) {
					const hex = computedColor.substring(1);
					// #RRGGBB (6 digits)
					if (hex.length === 6) {
							return {
									r: parseInt(hex.substring(0, 2), 16),
									g: parseInt(hex.substring(2, 4), 16),
									b: parseInt(hex.substring(4, 6), 16),
									a: 1
							};
					}
					// #RRGGBBAA (8 digits)
					if (hex.length === 8) {
							return {
									r: parseInt(hex.substring(0, 2), 16),
									g: parseInt(hex.substring(2, 4), 16),
									b: parseInt(hex.substring(4, 6), 16),
									a: parseInt(hex.substring(6, 8), 16) / 255
							};
					}
			}
			// Match rgba() or rgb() format (for browsers that return this format)
			const rgbaMatch = computedColor.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)$/);
			if (rgbaMatch) {
					return {
							r: parseInt(rgbaMatch[1], 10),
							g: parseInt(rgbaMatch[2], 10),
							b: parseInt(rgbaMatch[3], 10),
							a: rgbaMatch[4] !== undefined ? parseFloat(rgbaMatch[4]) : 1
					};
			}

			return null; // Invalid color
	}

	// Helper to convert back to Hex (for output consistency)
	function lv_rgbToHex(r, g, b) {
		const toHex = (n) => {
			const hex = Math.max(0, Math.min(255, n)).toString(16)
			return hex.length === 1 ? '0' + hex : hex
		}
		return `#${toHex(r)}${toHex(g)}${toHex(b)}`
	}

	function lv_isTransparent(color) {
		const cleanColor = lv_parseColorToRgba(color);
		// check #RRGGBBAA for transparency
		return !cleanColor || (cleanColor.a !== undefined && !cleanColor.a);
	}

	function lv_getColorSchema(color) {
		const rgb = lv_parseColorToRgba(color);
		if (!rgb) return 'unknown'; // Handle invalid colors
		// Calculate YIQ brightness (human eye perception)
		const brightness = ((rgb.r * 299) + (rgb.g * 587) + (rgb.b * 114)) / 1000;
		
		return brightness > 128 ? 'light' : 'dark';
	}

	function lv_lighter(color, amount) {
		const rgb = lv_parseColorToRgba(color);
		if (!rgb) return color;
		// Add amount to each channel
		const r = rgb.r + amount;
		const g = rgb.g + amount;
		const b = rgb.b + amount;
		// Convert back to Hex (clamping happens inside rgbToHex)
		return lv_rgbToHex(r, g, b);
	}

	function lv_darker(color, amount) {
		const rgb = lv_parseColorToRgba(color);
		if (!rgb) return color;
		// Subtract amount from each channel
		const r = rgb.r - amount;
		const g = rgb.g - amount;
		const b = rgb.b - amount;

		return lv_rgbToHex(r, g, b);
	}

	// copy select styles
	function lv_adaptiveStyle(cbid) {
		const display = document.getElementById(cbid + ".display");
		const hiddenSelect = document.getElementById(cbid);
		const panel = document.getElementById(cbid + ".panel");
		if (hiddenSelect && display) {
			const elOption = hiddenSelect.getElementsByTagName("option")[0]
			const styleSelect = window.getComputedStyle(hiddenSelect)
			const styleOption = window.getComputedStyle(elOption)
			const styleBody = window.getComputedStyle(document.body)

			const styleNode = document.createElement('style')
			const styleNames = ["width", "color", "height", "padding", "margin", "lineHeight", "border", "borderRadius", "minWidth", "minHeight"]
			if (styleSelect.borderBottomStyle !== "none") {
				styleNames.push("borderBottomWidth", "borderBottomStyle", "borderBottomColor");
			}
			document.head.appendChild(styleNode)
			// trace back from option -> select -> body for background color
			const panelRadius = styleSelect.borderRadius;
			const optionColor = !lv_isTransparent(styleOption.backgroundColor) ? styleOption.backgroundColor : !lv_isTransparent(styleSelect.backgroundColor) ? styleSelect.backgroundColor : styleBody.backgroundColor
			const titleColor = lv_getColorSchema(optionColor) === "light" ? lv_darker(optionColor, 30) : lv_lighter(optionColor, 30)
			const selectStyleCSS = [`#${CSS.escape(cbid + ".display")} {`, lv_style2Css(styleSelect, styleNames), lv_style2Css(styleSelect, ["backgroundColor"]), "}"]
			const optionStyleCSS = [`#${CSS.escape(cbid + ".panel")}  {`, lv_style2Css(styleOption, styleNames), `background-color: ${optionColor};`, `border-radius: ${panelRadius};`, "}"]
			const titleStyleCSS = [`#${CSS.escape(cbid + ".panel")} .lv-group-title  {`, `background-color: ${titleColor} !important;`, "}"]
			styleNode.textContent = [].concat(selectStyleCSS, optionStyleCSS, titleStyleCSS).join("\n")
		}
	}

	function lv_idSafe(id) {
		return id
			.trim()
			.replace(/\s+/g, "-")
			.replace(/[\x00-\x1F\x7F]/g, "");
	}

	// 高亮当前选中的项
	function lv_highlightSelectedItem(listContainer, hiddenSelect) {
		const allItems = listContainer.querySelectorAll("li[data-key]");
		const currentKey = hiddenSelect.options[0].value;
		allItems.forEach(item => {
			item.classList.remove("is-selected");
			if (item.getAttribute('data-key') === currentKey) {
				item.classList.add("is-selected");
			}
		});
	}

	// 更新组内选中计数
	function lv_updateGroupCounts(cbid, listContainer, hiddenSelect, searchInput) {
		const groups = listContainer.querySelectorAll(".lv-group");
		const currentKey = hiddenSelect.options[0].value;
		const isSearching = searchInput.value.trim() !== "";
		groups.forEach(group => {
			const gname = group.getAttribute("data-group");
			const items = group.querySelectorAll("li[data-key]");
			const span = document.getElementById("group-count-" + cbid + "-" + gname);
			if (!span) return;
			if (isSearching) {
				// 搜索状态：显示匹配数量
				let matchCount = 0;
				items.forEach(li => {
					if (li.style.display !== "none") matchCount++;
				});
				span.textContent = "(" + matchCount + "/" + items.length + ")";
				if (matchCount > 0) {
					span.style.color = "#28a745";
					span.style.fontWeight = "600";
				} else {
					span.style.color = "#dc3545";
					span.style.fontWeight = "normal";
				}
			} else {
				// 默认状态：显示选中项数量
				let selectedCount = 0;
				items.forEach(li => {
					if (li.getAttribute('data-key') === currentKey) {
						selectedCount = 1;
					}
				});
				span.textContent = "(" + selectedCount + "/" + items.length + ")";
				if (selectedCount > 0) {
					span.style.color = "#007bff";
					span.style.fontWeight = "600";
				} else {
					span.style.color = "";
					span.style.fontWeight = "normal";
				}
			}
		});
	}

	//搜索过滤器：按 name 或 label 做模糊匹配，搜索时自动展开所有组并隐藏不匹配条目
	function lv_filterList(keyword, cbid, listContainer, hiddenSelect, searchInput) {
		keyword = (keyword || "").toLowerCase().trim();
		const topItems = listContainer.querySelectorAll("ul li[data-key]");
		topItems.forEach(li=>{
			const name = (li.getAttribute("data-node-name") || "").toLowerCase();
			if (!keyword || name.indexOf(keyword) !== -1) {
				li.style.display = "block";
			} else {
				li.style.display = "none";
			}
		});
		const groups = listContainer.querySelectorAll(".lv-group");
		groups.forEach(group=>{
			const items = group.querySelectorAll("li[data-key]");
			let matchCount = 0;
			items.forEach(li=>{
				const name = (li.getAttribute("data-node-name") || "").toLowerCase();
				if (!keyword || name.indexOf(keyword) !== -1) {
					li.style.display = "block";
					matchCount++;
				} else {
					li.style.display = "none";
				}
			});
			group.style.display = (matchCount === 0 && keyword !== "") ? "none" : "block";
			const ul = group.querySelector(".lv-group-list");
			const gname = group.getAttribute("data-group");
			const arrow = document.getElementById("arrow-" + cbid + "-" + gname);
			if (keyword) {
				if (ul) ul.style.display = (matchCount > 0 ? "block" : "none");
				if (arrow) arrow.className = (matchCount > 0 ? "lv-arrow-down-small" : "lv-arrow-right");
			} else {
				if (ul) ul.style.display = "none";
				if (arrow) arrow.className = "lv-arrow-right";
			}
		});
		lv_updateGroupCounts(cbid, listContainer, hiddenSelect, searchInput);
		lv_highlightSelectedItem(listContainer, hiddenSelect);
	}

	// 切换单个组（点击组标题）
	function lv_toggleGroup(listContainer, cbid, g) {
		g = lv_idSafe(g);
		const group = listContainer.querySelector(".lv-group[data-group='" + g + "']");
		if (!group) return;
		const ul = group.querySelector(".lv-group-list");
		const arrow = document.getElementById("arrow-" + cbid + "-" + g);
		if (!ul) return;
		const searchInput = document.getElementById(cbid + ".search");
		const isSearching = searchInput?.value.trim() !== "";
		const isExpanded = ul.style.display !== "none";

		if (isExpanded) {
			ul.style.display = "none";
			if (arrow) arrow.className = "lv-arrow-right";
		} else {
			ul.style.display = "block";
			if (arrow) arrow.className = "lv-arrow-down-small";

			if (!isSearching) {
				const allGroups = listContainer.querySelectorAll(".lv-group");
				allGroups.forEach(otherGroup => {
					if (otherGroup !== group) {
						const otherUl = otherGroup.querySelector(".lv-group-list");
						const otherGname = otherGroup.getAttribute("data-group");
						const otherArrow = document.getElementById("arrow-" + cbid + "-" + otherGname);
						if (otherUl) otherUl.style.display = "none";
						if (otherArrow) otherArrow.className = "lv-arrow-right";
					}
				});
			}
		}
	}

	// 展开包含当前 hiddenSelect 值的组（初始化或打开面板时使用）
	function lv_expandGroupOfCurrent(cbid, listContainer, hiddenSelect) {
		const key = hiddenSelect.options[0].value;
		if (!key) return;
		const targetLi = listContainer.querySelector("li[data-key='" + key.replace(/'/g,"\\'") + "']");
		if (!targetLi) return;
		let parentGroup = targetLi.closest(".lv-group");
		if (parentGroup) {
			const ul = parentGroup.querySelector(".lv-group-list");
			const gname = parentGroup.getAttribute("data-group");
			const arrow = document.getElementById("arrow-" + cbid + "-" + gname);
			if (ul) ul.style.display = "block";
			if (arrow) arrow.className = "lv-arrow-down-small";
			const allGroups = listContainer.querySelectorAll(".lv-group");
			allGroups.forEach(gp=>{
				if (gp !== parentGroup) {
					const gul = gp.querySelector(".lv-group-list");
					const otherGname = gp.getAttribute("data-group");
					const gar = document.getElementById("arrow-" + cbid + "-" + otherGname);
					if (gul) gul.style.display = "none";
					if (gar) gar.className = "lv-arrow-right";
				}
			});
		} else {
			const allGroups = listContainer.querySelectorAll(".lv-group");
			allGroups.forEach(gp=>{
				const gul = gp.querySelector(".lv-group-list");
				const gname = gp.getAttribute("data-group");
				const gar = document.getElementById("arrow-" + cbid + "-" + gname);
				if (gul) gul.style.display = "none";
				if (gar) gar.className = "lv-arrow-right";
			});
		}
		if (targetLi) {
			requestAnimationFrame(() => {
				targetLi.scrollIntoView({ block: "nearest" });
			});
		}
	}

	// 计算panel位置
	function lv_repositionPanel(panel, display) {
		if (!panel || panel.style.display === "none") return;
		const rect = display.getBoundingClientRect();
		const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
		panel.style.visibility = "hidden";
		panel.style.display = "block";
		panel.style.minHeight = "100px";
		panel.style.maxHeight = Math.min(0.5*viewportHeight, 550) + "px";
		const panelHeight = panel.offsetHeight;
		const spaceBelow = viewportHeight - rect.bottom;
		const spaceAbove = rect.top;
		let top, isUp = false;
		if (spaceBelow >= panelHeight) {
			top = rect.bottom + 2;
			isUp = false;
		} else if (spaceAbove >= panelHeight) {
			top = rect.top - panelHeight - 2;
			isUp = true;
		} else {
			if (spaceBelow >= spaceAbove) {
				top = Math.max(rect.bottom - 2, viewportHeight - panelHeight - 2);
				isUp = false;
			} else {
				top = Math.min(rect.top - panelHeight + 2, 2);
				isUp = true;
			}
		}
		panel.style.left = rect.left + "px";
		panel.style.top = top + "px";
		const panelRect = panel.getBoundingClientRect();
		const displayWidth = rect.width;
		const remainingWidth = window.innerWidth - panelRect.left - 12;
		const maxWidth = Math.max(displayWidth, Math.floor(remainingWidth));
		panel.style.maxWidth = maxWidth + "px";
		panel.style.minWidth = displayWidth + "px";
		panel.style.width = "auto";
		panel.style.visibility = "";
	}

	// 打开/关闭面板
	function lv_openPanel(cbid, display, panel, listContainer, hiddenSelect, searchInput) {
		if (!panel._moved) {
			document.body.appendChild(panel);
			panel._moved = true;
		}
		lv_expandGroupOfCurrent(cbid, listContainer, hiddenSelect);
		lv_highlightSelectedItem(listContainer, hiddenSelect);
		panel.style.display = "block";
		lv_repositionPanel(panel, display);
		// 失焦监听
		const handler = function(e){
			const target = e.target;
			if (panel.style.display !== "none") {
				if (!panel.contains(target) && !display.contains(target)) {
					lv_closePanel(cbid, panel, listContainer, hiddenSelect, searchInput, display);
				}
			}
		}
		panel._docClickHandler = handler;
		document.addEventListener("click", handler);
		// 滚动 / resize 自动 reposition
		let ticking = false;
		const repositionHandler = function () {
			if (ticking) return;
			ticking = true;
			requestAnimationFrame(function () {
				ticking = false;
				lv_repositionPanel(panel, display);
			});
		};
		panel._repositionHandler = repositionHandler;
		window.addEventListener("scroll", repositionHandler, true);
		window.addEventListener("resize", repositionHandler);
	}
	function lv_closePanel(cbid, panel, listContainer, hiddenSelect, searchInput) {
		panel.style.display = "none";
		searchInput.value = "";
		lv_filterList("", cbid, listContainer, hiddenSelect, searchInput);
		// document click
		if (panel._docClickHandler) {
			document.removeEventListener("click", panel._docClickHandler);
			panel._docClickHandler = null;
		}
		// scroll / resize
		if (panel._repositionHandler) {
			window.removeEventListener("scroll", panel._repositionHandler, true);
			window.removeEventListener("resize", panel._repositionHandler);
			panel._repositionHandler = null;
		}
	}

	// 动态生成下拉框
	window.lv_dropdown_rendered = {};
	function lv_escape_html(s) {
		return s.replace(/[&<>"']/g, c => ({
			"&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;"
		}[c]));
	}
	function lv_render_dropdown_list(cbid, panel, listContainer, hiddenSelect, labelSpan, searchInput, display) {
		if (window.lv_dropdown_rendered[cbid]) return;
		const data = window.lv_dropdown_data[cbid];
		if (!data) return;
		if (!listContainer) return;

		let html = "";

		// 无组项
		if (data.ungrouped && data.ungrouped.length > 0) {
			html += `<ul style="list-style:none;padding:0;margin:0 0 8px 0;">`;

			data.ungrouped.forEach(item => {
				html += `
					<li data-key="${item.key}"
						data-node-name="${lv_escape_html(item.label.toLowerCase())}"
						class="list-item">
						<span class="lv-item-label" style="margin-left:12px;">
							${lv_escape_html(item.label)}
						</span>
					</li>`;
			});

			html += `</ul>`;
		}

		// 分组项
		data.group_order.forEach(gname => {
			const items = data.groups[gname];

			html += `
			<div class="lv-group" data-group="${lv_idSafe(gname)}" style="margin-bottom:8px;">
				<div class="lv-group-title" data-group-name="${lv_idSafe(gname)}">
					<span class="lv-arrow-right" id="arrow-${cbid}-${lv_idSafe(gname)}"></span>
					<b style="margin-left:6px;">${lv_escape_html(gname)}</b>
					<span id="group-count-${cbid}-${lv_idSafe(gname)}"
						style="margin-left:8px;">(0/${items.length})</span>
				</div>
				<ul id="group-${cbid}-${lv_idSafe(gname)}" class="lv-group-list" style="display:none">
			`;

			items.forEach(item => {
				html += `
				<li data-key="${item.key}"
					data-node-name="${lv_escape_html(item.label.toLowerCase())}"
					class="lv-group-item">
					<span class="lv-item-label" title="${lv_escape_html(item.label)}">
						${lv_escape_html(item.label)}
					</span>
				</li>`;
			});

			html += `
				</ul>
			</div>
			`;
		});

		listContainer.innerHTML = html;

		window.lv_dropdown_rendered[cbid] = true;

		lv_adaptiveStyle(cbid);
		lv_updateGroupCounts(cbid, listContainer, hiddenSelect, searchInput);

		// 点击项（无组与组内项都使用 li[data-key]）
		listContainer.addEventListener("click", function(e){
			let li = e.target;
			while(li && li !== listContainer && !li.hasAttribute('data-key')) li = li.parentNode;
			if(!li || li === listContainer) return;
			const key = li.getAttribute('data-key') || "";
			const text = li.querySelector(".lv-item-label")?.textContent || li.textContent || key;

			const changed = key !== hiddenSelect.value;
			if (changed) {
				//改值
				hiddenSelect.options[0].value = key;
				hiddenSelect.options[0].text = key;
				hiddenSelect.value = key;
				labelSpan.textContent = text;
				labelSpan.title = text;
				lv_highlightSelectedItem(listContainer, hiddenSelect);
				lv_updateGroupCounts(cbid, listContainer, hiddenSelect, searchInput);
			}
			lv_closePanel(cbid,panel,listContainer,hiddenSelect,searchInput);
			if (changed) {
				setTimeout(() => {
					hiddenSelect.dispatchEvent(new Event('change', { bubbles: true }));
				}, 0);
			}
		});

		// 搜索功能
		searchInput.addEventListener("input", function() {
			lv_filterList(this.value, cbid, listContainer, hiddenSelect, searchInput);
			lv_repositionPanel(panel, display);
		});
		searchInput.addEventListener('keydown', function(e) {
			const isEnter = e.key === "Enter" || e.keyCode === 13;
			if (!isEnter) return;
			e.stopPropagation();
			e.preventDefault();
			searchInput.blur();
		});

		// 切换组
		listContainer.querySelectorAll(".lv-group-title").forEach(title => {
			title.addEventListener("click", function() {
				const g = this.closest(".lv-group")?.getAttribute("data-group");
				if (g) {
					lv_toggleGroup(listContainer, cbid, g);
					lv_repositionPanel(panel, display);
				}
			});
		});
	}

	const lv_adaptiveControls = new Set();
	function lv_registerAdaptive(cbid) {
		lv_adaptiveControls.add(cbid);
		lv_adaptiveStyle(cbid);
	}
	let lv_adaptiveTicking = false;
	window.addEventListener("resize", () => {
		if (!lv_adaptiveTicking) {
			lv_adaptiveTicking = true;
			requestAnimationFrame(() => {
				lv_adaptiveControls.forEach(cbid => lv_adaptiveStyle(cbid));
				lv_adaptiveTicking = false;
			});
		}
	});
//]]>
</script>
